generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  SUPPLIER
  ADMIN
}

enum OrderType {
  RETAIL
  WHOLESALE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum ShipmentStatus {
  PREPARING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(CUSTOMER)
  phone     String?
  avatar    String?

  refreshToken String?

  addresses Address[]
  products  Product[]  @relation("SupplierProducts")
  orders    Order[]

  confirmedPayments Payment[] @relation("PaymentConfirmedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  label      String  @default("Home")
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String
  isDefault  Boolean @default(false)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model Category {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  image    String?
  parentId String?

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Product {
  id             String  @id @default(cuid())
  name           String
  slug           String  @unique
  description    String?
  basePrice      Float
  wholesalePrice Float?
  wholesaleMin   Int?
  images         String[]
  featured       Boolean @default(false)
  active         Boolean @default(true)

  supplierId String
  categoryId String

  supplier User     @relation("SupplierProducts", fields: [supplierId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  variants   ProductVariant[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model ProductVariant {
  id          String  @id @default(cuid())
  sku         String  @unique
  size        String?
  color       String?
  material    String?
  priceOffset Float   @default(0)
  stock       Int     @default(0)
  active      Boolean @default(true)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_variants")
}

model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  type         OrderType   @default(RETAIL)
  status       OrderStatus @default(PENDING)
  subtotal     Float
  shippingCost Float
  total        Float
  notes        String?

  userId    String
  addressId String

  user    User    @relation(fields: [userId], references: [id])
  address Address @relation(fields: [addressId], references: [id])

  items    OrderItem[]
  shipment Shipment?
  payment  Payment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

model OrderItem {
  id       String @id @default(cuid())
  quantity Int
  price    Float

  orderId   String
  productId String
  variantId String?

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model ShippingZone {
  id            String   @id @default(cuid())
  name          String
  countries     String[]
  baseCost      Float
  perKgCost     Float    @default(0)
  estimatedDays Int      @default(7)

  shipments Shipment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shipping_zones")
}

model Shipment {
  id             String         @id @default(cuid())
  status         ShipmentStatus @default(PREPARING)
  trackingNumber String?
  carrier        String?
  estimatedDate  DateTime?
  shippedDate    DateTime?
  deliveredDate  DateTime?

  orderId        String       @unique
  shippingZoneId String

  order        Order        @relation(fields: [orderId], references: [id])
  shippingZone ShippingZone @relation(fields: [shippingZoneId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shipments")
}

model Payment {
  id            String        @id @default(cuid())
  status        PaymentStatus @default(PENDING)
  method        String        @default("manual")
  amount        Float
  currency      String        @default("USD")
  transactionId String?
  confirmedById String?

  orderId String @unique

  order       Order @relation(fields: [orderId], references: [id])
  confirmedBy User? @relation("PaymentConfirmedBy", fields: [confirmedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  @@map("waitlist_entries")
}
